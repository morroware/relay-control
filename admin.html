<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Settings</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #121212;
            color: #e0e0e0;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        .container {
            background-color: #1e1e1e;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
            max-width: 1200px;
            width: 100%;
            border: 1px solid #333;
        }
        h1 {
            text-align: center;
            color: #ffffff;
            margin-bottom: 20px;
        }
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        .full-width {
            grid-column: 1 / -1;
        }
        .form-section {
            background-color: #2a2a2a;
            padding: 20px;
            border-radius: 8px;
        }
        h2 {
            color: #FFAB00;
            margin-top: 0;
            border-bottom: 1px solid #444;
            padding-bottom: 10px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            color: #ccc;
        }
        input, select {
            width: 100%;
            padding: 8px;
            margin-bottom: 15px;
            border-radius: 4px;
            border: 1px solid #555;
            background-color: #333;
            color: #eee;
            box-sizing: border-box;
        }
        .relay-pins-grid, .relay-timers-grid {
            display: grid;
            grid-template-columns: auto 1fr auto;
            gap: 10px;
            align-items: center;
        }
        .checkbox-container {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        .checkbox-container input[type="checkbox"] {
            width: auto;
            margin-right: 10px;
            margin-bottom: 0;
        }
        .submit-button {
            grid-column: 1 / -1;
            background-color: #C62828;
            color: white;
            border: none;
            padding: 15px;
            font-size: 18px;
            font-weight: bold;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            margin-top: 20px;
        }
        .submit-button:hover {
            background-color: #D32F2F;
        }
        .submit-button:disabled {
            background-color: #666;
            cursor: not-allowed;
        }
        .status {
            text-align: center;
            padding: 10px;
            margin-top: 20px;
            border-radius: 5px;
            font-weight: bold;
            display: none;
        }
        .status.success {
            background-color: #1B5E20;
            color: #A5D8A6;
            display: block;
        }
        .status.error {
            background-color: #B71C1C;
            color: #FFCDD2;
            display: block;
        }
        .status.warning {
            background-color: #F57C00;
            color: #FFE0B2;
            display: block;
        }
        a {
            color: #66BB6A;
            text-decoration: none;
            display: block;
            text-align: center;
            margin-top: 20px;
        }
        .info-text {
            font-size: 12px;
            color: #888;
            margin-top: 5px;
            margin-bottom: 10px;
        }
        .timer-unit {
            font-size: 12px;
            color: #ccc;
            padding: 8px;
            background-color: #333;
            border: 1px solid #555;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .preset-buttons {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        .preset-btn {
            background-color: #444;
            color: #ccc;
            border: 1px solid #666;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: background-color 0.3s ease;
        }
        .preset-btn:hover {
            background-color: #555;
        }
        .error-text {
            color: #EF5350;
            font-size: 12px;
            margin-top: -10px;
            margin-bottom: 10px;
            display: none;
        }
        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
            .relay-pins-grid, .relay-timers-grid {
                grid-template-columns: auto 1fr;
            }
            .timer-unit {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Admin Configuration</h1>
        <form id="configForm">
            <div class="form-grid">
                <div class="form-section">
                    <h2>General Settings</h2>
                    <label for="max_concurrent_triggers">Max Concurrent Triggers</label>
                    <input type="number" id="max_concurrent_triggers" name="max_concurrent_triggers" min="1" max="8">

                    <label for="active_low">Relay Type (Active Low)</label>
                    <select id="active_low" name="active_low">
                        <option value="true">True</option>
                        <option value="false">False</option>
                    </select>
                </div>

                <div class="form-section">
                    <h2>Physical Button</h2>
                    <div class="checkbox-container">
                        <input type="checkbox" id="button_enabled" name="button_enabled">
                        <label for="button_enabled">Enable Physical Button</label>
                    </div>

                    <label for="button_pin">Button GPIO Pin</label>
                    <input type="number" id="button_pin" name="button_pin" min="0" max="27">

                    <label for="button_target_relay">Target Relay (1-8)</label>
                    <input type="number" id="button_target_relay" name="button_target_relay" min="1" max="8">

                    <div class="checkbox-container">
                        <input type="checkbox" id="button_pull_up" name="button_pull_up">
                        <label for="button_pull_up">Use Internal Pull-up</label>
                    </div>

                    <label for="button_debounce_time">Debounce Time (seconds)</label>
                    <input type="number" id="button_debounce_time" name="button_debounce_time" step="0.1" min="0.1" max="2">
                    <div class="info-text">Recommended: 0.3 seconds</div>
                </div>
            </div>

            <div class="form-grid">
                <div class="form-section">
                    <h2>Relay GPIO Pins</h2>
                    <div class="info-text">Valid GPIO range: 0-27. Ensure no duplicates!</div>
                    <div id="gpio-error" class="error-text"></div>
                    <div class="relay-pins-grid">
                        <label for="pin1">Relay 1:</label> <input type="number" id="pin1" name="pin1" min="0" max="27"> <span></span>
                        <label for="pin2">Relay 2:</label> <input type="number" id="pin2" name="pin2" min="0" max="27"> <span></span>
                        <label for="pin3">Relay 3:</label> <input type="number" id="pin3" name="pin3" min="0" max="27"> <span></span>
                        <label for="pin4">Relay 4:</label> <input type="number" id="pin4" name="pin4" min="0" max="27"> <span></span>
                        <label for="pin5">Relay 5:</label> <input type="number" id="pin5" name="pin5" min="0" max="27"> <span></span>
                        <label for="pin6">Relay 6:</label> <input type="number" id="pin6" name="pin6" min="0" max="27"> <span></span>
                        <label for="pin7">Relay 7:</label> <input type="number" id="pin7" name="pin7" min="0" max="27"> <span></span>
                        <label for="pin8">Relay 8:</label> <input type="number" id="pin8" name="pin8" min="0" max="27"> <span></span>
                    </div>
                </div>

                <div class="form-section">
                    <h2>Individual Relay Timers</h2>
                    <div class="info-text">Set different trigger durations for each relay (0.1 - 300 seconds)</div>
                    
                    <div class="preset-buttons">
                        <button type="button" class="preset-btn" onclick="setAllTimers(1)">1s All</button>
                        <button type="button" class="preset-btn" onclick="setAllTimers(2)">2s All</button>
                        <button type="button" class="preset-btn" onclick="setAllTimers(5)">5s All</button>
                        <button type="button" class="preset-btn" onclick="setAllTimers(10)">10s All</button>
                    </div>

                    <div class="relay-timers-grid">
                        <label for="timer1">Relay 1:</label> <input type="number" id="timer1" name="timer1" step="0.1" min="0.1" max="300"> <span class="timer-unit">seconds</span>
                        <label for="timer2">Relay 2:</label> <input type="number" id="timer2" name="timer2" step="0.1" min="0.1" max="300"> <span class="timer-unit">seconds</span>
                        <label for="timer3">Relay 3:</label> <input type="number" id="timer3" name="timer3" step="0.1" min="0.1" max="300"> <span class="timer-unit">seconds</span>
                        <label for="timer4">Relay 4:</label> <input type="number" id="timer4" name="timer4" step="0.1" min="0.1" max="300"> <span class="timer-unit">seconds</span>
                        <label for="timer5">Relay 5:</label> <input type="number" id="timer5" name="timer5" step="0.1" min="0.1" max="300"> <span class="timer-unit">seconds</span>
                        <label for="timer6">Relay 6:</label> <input type="number" id="timer6" name="timer6" step="0.1" min="0.1" max="300"> <span class="timer-unit">seconds</span>
                        <label for="timer7">Relay 7:</label> <input type="number" id="timer7" name="timer7" step="0.1" min="0.1" max="300"> <span class="timer-unit">seconds</span>
                        <label for="timer8">Relay 8:</label> <input type="number" id="timer8" name="timer8" step="0.1" min="0.1" max="300"> <span class="timer-unit">seconds</span>
                    </div>
                </div>
            </div>

            <button type="submit" class="submit-button" id="submitBtn">Save and Restart Service</button>
        </form>
        <div id="status" class="status"></div>
        <a href="/">Back to Control Panel</a>
    </div>

    <script>
        // Helper function to set all timers to the same value
        function setAllTimers(seconds) {
            for (let i = 1; i <= 8; i++) {
                document.getElementById(`timer${i}`).value = seconds;
            }
        }

        // Validate GPIO pins
        function validateGPIOPins() {
            const pins = [];
            const errorDiv = document.getElementById('gpio-error');
            
            // Collect all GPIO pins
            for (let i = 1; i <= 8; i++) {
                const pinInput = document.getElementById(`pin${i}`);
                const pin = parseInt(pinInput.value);
                
                if (isNaN(pin) || pin < 0 || pin > 27) {
                    errorDiv.textContent = `GPIO pin for Relay ${i} must be between 0 and 27`;
                    errorDiv.style.display = 'block';
                    return false;
                }
                
                pins.push(pin);
            }
            
            // Check for duplicates
            const uniquePins = new Set(pins);
            if (uniquePins.size !== pins.length) {
                errorDiv.textContent = 'Duplicate GPIO pins detected!';
                errorDiv.style.display = 'block';
                return false;
            }
            
            // Check if button pin conflicts with relay pins
            if (document.getElementById('button_enabled').checked) {
                const buttonPin = parseInt(document.getElementById('button_pin').value);
                if (pins.includes(buttonPin)) {
                    errorDiv.textContent = 'Button GPIO pin conflicts with relay pins!';
                    errorDiv.style.display = 'block';
                    return false;
                }
            }
            
            errorDiv.style.display = 'none';
            return true;
        }

        // Add real-time GPIO validation
        document.querySelectorAll('input[id^="pin"]').forEach(input => {
            input.addEventListener('change', validateGPIOPins);
        });
        document.getElementById('button_pin').addEventListener('change', validateGPIOPins);
        document.getElementById('button_enabled').addEventListener('change', validateGPIOPins);

        // Fetch current config and populate the form
        fetch('/admin/config')
            .then(response => response.json())
            .then(config => {
                // General settings
                document.getElementById('max_concurrent_triggers').value = config.relay_settings.max_concurrent_triggers;
                document.getElementById('active_low').value = config.relay_settings.active_low.toString();
                
                // Relay pins
                for (let i = 1; i <= 8; i++) {
                    document.getElementById(`pin${i}`).value = config.relay_pins[i.toString()];
                }
                
                // Relay timers
                for (let i = 1; i <= 8; i++) {
                    document.getElementById(`timer${i}`).value = config.relay_timers[i.toString()];
                }
                
                // Physical button settings
                document.getElementById('button_enabled').checked = config.physical_button.enabled;
                document.getElementById('button_pin').value = config.physical_button.pin;
                document.getElementById('button_target_relay').value = config.physical_button.target_relay;
                document.getElementById('button_pull_up').checked = config.physical_button.pull_up;
                document.getElementById('button_debounce_time').value = config.physical_button.debounce_time;
            })
            .catch(error => {
                console.error('Error loading configuration:', error);
                document.getElementById('status').className = 'status error';
                document.getElementById('status').textContent = 'Failed to load current configuration';
                document.getElementById('status').style.display = 'block';
            });

        // Handle form submission
        document.getElementById('configForm').addEventListener('submit', function(event) {
            event.preventDefault();
            const statusDiv = document.getElementById('status');
            const submitBtn = document.getElementById('submitBtn');
            statusDiv.style.display = 'none';

            // Validate GPIO pins first
            if (!validateGPIOPins()) {
                return;
            }

            const formData = new FormData(event.target);
            
            // Build relay_timers object
            const relayTimers = {};
            for (let i = 1; i <= 8; i++) {
                relayTimers[i.toString()] = parseFloat(formData.get(`timer${i}`));
            }
            
            // Build relay_pins object
            const relayPins = {};
            for (let i = 1; i <= 8; i++) {
                relayPins[i.toString()] = parseInt(formData.get(`pin${i}`));
            }

            const data = {
                relay_settings: {
                    max_concurrent_triggers: parseInt(formData.get('max_concurrent_triggers')),
                    active_low: formData.get('active_low') === 'true'
                },
                relay_pins: relayPins,
                relay_timers: relayTimers,
                physical_button: {
                    enabled: formData.get('button_enabled') === 'on',
                    pin: parseInt(formData.get('button_pin')),
                    target_relay: parseInt(formData.get('button_target_relay')),
                    pull_up: formData.get('button_pull_up') === 'on',
                    debounce_time: parseFloat(formData.get('button_debounce_time'))
                }
            };

            // Client-side validation
            let validationError = null;
            
            // Validate timer values
            for (let i = 1; i <= 8; i++) {
                const timer = relayTimers[i.toString()];
                if (isNaN(timer) || timer < 0.1 || timer > 300) {
                    validationError = `Relay ${i} timer must be between 0.1 and 300 seconds`;
                    break;
                }
            }
            
            // Validate debounce time
            if (data.physical_button.enabled) {
                const debounce = data.physical_button.debounce_time;
                if (isNaN(debounce) || debounce < 0.1 || debounce > 2.0) {
                    validationError = 'Debounce time must be between 0.1 and 2.0 seconds';
                }
            }

            if (validationError) {
                statusDiv.className = 'status error';
                statusDiv.textContent = validationError;
                statusDiv.style.display = 'block';
                return;
            }

            // Disable submit button during save
            submitBtn.disabled = true;
            submitBtn.textContent = 'Saving...';

            fetch('/admin/config', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.status === 'success') {
                    statusDiv.className = 'status success';
                    statusDiv.textContent = 'Configuration saved! Service is restarting...';
                    
                    // Show additional warning about reconnection
                    setTimeout(() => {
                        statusDiv.className = 'status warning';
                        statusDiv.textContent = 'Service restarting. You may need to refresh the page in a few seconds.';
                    }, 3000);
                } else {
                    statusDiv.className = 'status error';
                    statusDiv.textContent = `Error: ${result.message}`;
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Save and Restart Service';
                }
                statusDiv.style.display = 'block';
            })
            .catch(error => {
                statusDiv.className = 'status error';
                statusDiv.textContent = `An unexpected error occurred: ${error}`;
                statusDiv.style.display = 'block';
                submitBtn.disabled = false;
                submitBtn.textContent = 'Save and Restart Service';
            });
        });
    </script>
</body>
</html>
