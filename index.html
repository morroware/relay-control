<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>8-Relay Control Panel</title>
    <link rel="icon" type="image/x-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%234CAF50'><path d='M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-13h2v6h-2zm0 8h2v2h-2z'/></svg>">
    <style>
        body { font-family: Arial, sans-serif; background-color: #f0f0f0; margin: 0; padding: 20px; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        .container { background-color: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); max-width: 700px; width: 100%; position: relative; }
        h1 { text-align: center; color: #333; margin-bottom: 30px; }
        .relay-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px; }
        .relay-button { background-color: #4CAF50; color: white; border: none; padding: 15px; font-size: 16px; font-weight: bold; border-radius: 8px; cursor: pointer; transition: all 0.3s ease; position: relative; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 80px; }
        .relay-button:hover:not(:disabled) { background-color: #45a049; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); }
        .relay-button:disabled { background-color: #ff9800; cursor: not-allowed; animation: pulse 1s infinite alternate; }
        .relay-button.button-triggered { background-color: #2196F3; }
        .relay-name { font-size: 18px; }
        .relay-timer, .relay-countdown, .relay-source { font-size: 12px; font-weight: normal; opacity: 0.9; margin-top: 5px; }
        @keyframes pulse { from { opacity: 1; } to { opacity: 0.7; } }
        .status { text-align: center; padding: 10px; margin-top: 20px; border-radius: 5px; font-weight: bold; display: none; }
        .status.success { background-color: #d4edda; color: #155724; }
        .status.error { background-color: #f8d7da; color: #721c24; }
        .connection-status { text-align: center; font-size: 14px; color: #666; margin-bottom: 15px; }
        .connection-status.connected { color: #4CAF50; }
        .connection-status.disconnected { color: #f44336; }
        .admin-link { position: absolute; top: 15px; left: 15px; color: #666; text-decoration: none; font-size: 24px; }
        @media (max-width: 480px) { .relay-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div class="container">
        <a href="/admin" class="admin-link" title="Admin Settings">⚙️</a>
        <h1>8-Relay Control Panel</h1>
        <div class="connection-status" id="connectionStatus">Connecting...</div>
        <div class="relay-grid" id="relayGrid">
            </div>
        <div id="statusMessage" class="status"></div>
    </div>

    <script>
        const NUM_RELAYS = 8;
        let countdownIntervals = {};

        /**
         * Generates the initial relay buttons on page load.
         */
        function createRelayButtons() {
            const grid = document.getElementById('relayGrid');
            for (let i = 1; i <= NUM_RELAYS; i++) {
                const button = document.createElement('button');
                button.className = 'relay-button';
                button.id = `relay${i}`;
                button.onclick = () => triggerRelay(i);
                
                button.innerHTML = `
                    <div class="relay-name">Relay ${i}</div>
                    <div class="relay-timer" id="timer${i}">...</div>
                    <div class="relay-countdown" id="countdown${i}" style="display: none;"></div>
                    <div class="relay-source" id="source${i}" style="display: none;"></div>
                `;
                grid.appendChild(button);
            }
        }

        /**
         * Polls the backend /status endpoint to get the real-time state of all relays.
         * This ensures the UI is always in sync, even if a relay is triggered by the physical button.
         */
        function checkStatus() {
            fetch('/status')
                .then(response => {
                    if (!response.ok) throw new Error('Network response was not ok');
                    return response.json();
                })
                .then(data => {
                    document.getElementById('connectionStatus').textContent = 'Connected';
                    document.getElementById('connectionStatus').className = 'connection-status connected';

                    // Iterate through each relay from the status payload
                    for (let i = 1; i <= NUM_RELAYS; i++) {
                        const relayData = data.relays[i];
                        const button = document.getElementById(`relay${i}`);
                        const timerEl = document.getElementById(`timer${i}`);
                        
                        timerEl.textContent = `${relayData.timer_duration.toFixed(1)}s duration`;
                        
                        // If the server says the relay is active ('locked')
                        if (relayData.locked) {
                            if (!button.disabled) { // If the button isn't already disabled by this UI
                                startCountdown(i, relayData.timer_duration);
                            }
                            // Add special class if triggered by physical button
                            if (relayData.triggered_by_button) {
                                button.classList.add('button-triggered');
                                document.getElementById(`source${i}`).textContent = '(Physical Button)';
                                document.getElementById(`source${i}`).style.display = 'block';
                            }
                        } else {
                            // If the server says the relay is NOT active, ensure the UI reflects that.
                            if (button.disabled) {
                                stopCountdown(i);
                            }
                        }
                    }
                })
                .catch(error => {
                    console.error('Connection Error:', error);
                    document.getElementById('connectionStatus').textContent = 'Disconnected';
                    document.getElementById('connectionStatus').className = 'connection-status disconnected';
                });
        }

        /**
         * Starts a visual countdown on a relay button.
         */
        function startCountdown(relayNum, duration) {
            const button = document.getElementById(`relay${relayNum}`);
            const timerEl = document.getElementById(`timer${relayNum}`);
            const countdownEl = document.getElementById(`countdown${relayNum}`);
            
            button.disabled = true;
            timerEl.style.display = 'none';
            countdownEl.style.display = 'block';
            
            let remaining = duration;
            countdownIntervals[relayNum] = setInterval(() => {
                remaining -= 0.1;
                if (remaining > 0) {
                    countdownEl.textContent = `${remaining.toFixed(1)}s left`;
                } else {
                    stopCountdown(relayNum);
                }
            }, 100);
        }

        /**
         * Stops the visual countdown and resets the button to its default state.
         */
        function stopCountdown(relayNum) {
            if (countdownIntervals[relayNum]) {
                clearInterval(countdownIntervals[relayNum]);
                delete countdownIntervals[relayNum];
            }
            const button = document.getElementById(`relay${relayNum}`);
            button.disabled = false;
            button.classList.remove('button-triggered');
            document.getElementById(`timer${relayNum}`).style.display = 'block';
            document.getElementById(`countdown${relayNum}`).style.display = 'none';
            document.getElementById(`source${relayNum}`).style.display = 'none';
        }

        /**
         * Sends a POST request to the backend to trigger a relay.
         */
        function triggerRelay(relayNum) {
            const button = document.getElementById(`relay${relayNum}`);
            if (button.disabled) return;

            fetch(`/relay/${relayNum}`, { method: 'POST' })
                .then(response => {
                    if (response.status === 429) { // 429 Too Many Requests
                        showStatus('Relay is already active.', 'error');
                        return null;
                    }
                    if (!response.ok) throw new Error('Failed to trigger relay');
                    return response.json();
                })
                .then(data => {
                    if (data && data.status === 'success') {
                        showStatus(`Relay ${data.relay} triggered for ${data.duration}s`, 'success');
                        startCountdown(data.relay, data.duration);
                    }
                })
                .catch(error => {
                    console.error('Trigger Error:', error);
                    showStatus(error.message, 'error');
                });
        }
        
        /**
         * Displays a temporary status message at the bottom of the page.
         */
        function showStatus(message, type) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.className = `status ${type}`;
            statusDiv.textContent = message;
            
            setTimeout(() => {
                statusDiv.className = 'status';
            }, 3000);
        }

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            createRelayButtons();
            checkStatus(); // Initial check
            setInterval(checkStatus, 2000); // Poll for status every 2 seconds
        });
    </script>
</body>
</html>
